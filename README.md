---
# Практическое задание 9

## ЭФМО-02-25 

## Алиев Каяхан Командар оглы
---
# Информация о проекте
Реализация регистрации и входа пользователей. Хэширование паролей с bcrypt

## Цели занятия
-	Научиться безопасно хранить пароли (bcrypt), валидировать вход и обрабатывать ошибки.
-	Реализовать эндпоинты POST /auth/register и POST /auth/login.
-	Закрепить работу с БД (PostgreSQL + GORM или database/sql) и валидацией ввода.
-	Подготовить основу для JWT-аутентификации в следующем ПЗ (№10). 

## Файловая структура проекта:

<img width="1073" height="634" alt="image" src="https://github.com/user-attachments/assets/5ed216b4-3659-447e-9882-434022d2dad1" />

## Ключевые компоненты

cmd/api/main.go — точка входа приложения: инициализация конфигурации через переменные окружения, подключение к PostgreSQL с использованием GORM, выполнение миграции для таблицы пользователей, создание репозитория и обработчиков для работы с аутентификацией, настройка HTTP-маршрутов /auth/register и /auth/login с поддержкой регистрации и входа пользователей, запуск сервера на порту из конфигурации.

internal/platform/config/config.go — модуль конфигурации: загрузка параметров из переменных окружения (DB_DSN для строки подключения к PostgreSQL, BcryptCost для сложности хэширования паролей, Addr для адреса сервера), установка значений по умолчанию при их отсутствии.

internal/core/user.go — модель данных пользователя: структура User с полями ID, Email (с уникальным индексом), PasswordHash для безопасного хранения пароля, CreatedAt и UpdatedAt с тегами GORM и JSON для корректной работы с базой данных и HTTP-ответами.

internal/repo/postgres.go — модуль подключения к базе данных: обёртка над GORM для установки соединения с PostgreSQL через DSN-строку, настройка параметров подключения.

internal/repo/user_repo.go — слой доступа к данным: репозиторий пользователей с методами Create (с проверкой уникальности email), ByEmail (поиск пользователя по email), AutoMigrate (автоматическое создание и обновление схемы таблицы), включая обработку кастомных ошибок (ErrUserNotFound, ErrEmailTaken).

internal/http/handlers/auth.go — HTTP-обработчики аутентификации: реализация REST API для регистрации (валидация email и пароля, хэширование пароля с использованием bcrypt, сохранение в БД) и входа (проверка соответствия хэша пароля, безопасная обработка ошибок без раскрытия деталей), возврат JSON-ответов с соответствующими HTTP-статусами.
go.mod - файл модуля Go: описание зависимостей, версия Go, имя модуля

# Примечания по конфигурации и требования

Для запуска требуется:

Go: версия 1.25.1

PostgreSQL: версия не ниже 14

Docker: версия не ниже 29

<img width="841" height="232" alt="Установка Git и Go" src="https://github.com/user-attachments/assets/8e01d831-5a7f-4376-8348-9052b240aec9" />
<img width="860" height="654" alt="image" src="https://github.com/user-attachments/assets/2138e11d-ee33-4f00-9e6b-7cffa60aadd3" />


# Команды запуска/сборки
Для запуска http нужно выполнить 4 шага:
## 1) Клонировать данный репозиторий в удобную для вас папку:
```Powershell
git clone https://github.com/kayahan81/PZ9-Auth
```
## 2) Перейти в папку http:
```Powershell
cd PZ9-Auth
```
## 3) Загрузка зависимостей:
```Powershell
go mod tidy
```
## 4) Команда запуска
```Powershell
go run ./cmd/api
```

# Команда сборки
Для сборки бинарника и запуска .exe файла используются данные программы

```Powershell
go build -o server.exe .
server.exe
```
# Проверка работоспособности

## Базовый функционал

Регистрация 

<img width="1024" height="214" alt="image" src="https://github.com/user-attachments/assets/01485269-8870-47c0-80c2-b055bf1baebc" />

Повторная регистрация

<img width="1448" height="266" alt="image" src="https://github.com/user-attachments/assets/71f6bcd5-508f-40a7-acce-9144b425878f" />

Вход

<img width="1023" height="222" alt="image" src="https://github.com/user-attachments/assets/fead6803-b0b1-4862-9e4b-d781cd0ead4d" />

Вход (неверный)

<img width="1427" height="260" alt="image" src="https://github.com/user-attachments/assets/5c2c0503-15f4-4ac4-b3f6-d7cce785b591" />


# Ответы на вопросы

1.	В чём разница между хранением пароля и хранением его хэша? Зачем соль? Почему bcrypt, а не SHA-256? 
Хэширование vs. Шифрование
Шифрование (encryption): процесс, обратимый при знании ключа. Можно зашифровать и потом расшифровать.
Хэширование (hashing): одностороннее преобразование. Получить пароль обратно из хэша невозможно (или крайне затратно).
Для паролей нужно именно хэширование, а не шифрование.
соль (salt) — случайная строка, добавляемая к паролю перед хэшированием. Тогда даже два одинаковых пароля будут давать разные хэши.
bcrypt делает это автоматически: соль встроена в итоговый хэш.
Почему не MD5/SHA-1/SHA-256
Они быстрые → злоумышленники могут проверять миллионы паролей в секунду (brute force).
Нет встроенной соли (нужно добавлять вручную).

2.	Что произойдёт при снижении/повышении cost у bcrypt? Как подобрать значение? 
Чем выше cost, тем медленнее хэширование. Обычно используют значения 10–14. Для учебных целей — 12. Если поставить слишком большое значение — система будет тормозить при регистрации/логине. Если слишком маленькое — злоумышленник сможет быстрее перебирать пароли.

3.	Какие статусы и ответы должны возвращать POST /auth/register и POST /auth/login в типичных сценариях?
POST /auth/register:
201 Created — успешная регистрация:

json
{
  "status": "ok",
  "user": {
    "id": 123,
    "email": "user@example.com"
  }
}
400 Bad Request — некорректный запрос:

Отсутствует email или пароль

Пароль короче 8 символов

Невалидный email

json
{"error": "email_required_and_password_min_8"}
409 Conflict — email уже занят:

json
{"error": "email_taken"}
500 Internal Server Error — серверная ошибка:

json
{"error": "hash_failed"} или {"error": "db_error"}
POST /auth/login:
200 OK — успешный вход:

json
{
  "status": "ok",
  "user": {
    "id": 123,
    "email": "user@example.com"
  }
}
(В ПЗ10 здесь также будет токен)

400 Bad Request — некорректный запрос:

json
{"error": "email_and_password_required"}
401 Unauthorized — неверные учетные данные:

json
{"error": "invalid_credentials"}
500 Internal Server Error — серверная ошибка:

json
{"error": "db_error"}

4.	Какие риски несут подробные сообщения об ошибках при логине?
Информационная утечка (Information Disclosure):
 Сообщение "Неверный пароль" подтверждает существование email в системе
 Злоумышленник может проверять существование аккаунтов для фишинга или атак
Перебор email-адресов (Email Enumeration):
 Атакующий может составить список существующих пользователей
Ускорение брутфорс-атак:
 Знание структуры ошибок помогает оптимизировать атаки
 Можно сначала проверять существующие email, затем подбирать пароли
 
5.	Почему в этом ПЗ не выдаём токен, и что изменится в ПЗ10 (JWT)? 
В пз10 будет генерация JWT токенов при успешном входе.
В пз9 учимся хранить и проверять пароли, а в 10 на этом фундаменте учимся с ними работать
